<div id='popup'></div>
<script>

	// Update spinner
	let spinnerLoaderElement = null;

	// Modal update commande
	let updateOrderElement = null;

	//Form contenant le formulaire de soumission d'un update
	let updateOrderFormElement = null;

	// Form contenant les filtres d'affichage
	let filterOrderFormElement = null;

	// Message Element
	let flashMessageElement = null

	// Select Date on filter
	let selectDayFilterElement = null;

	// Commande cliquée pour modification
	let orderElement = null;

	// Commmande récupérer en base de données
	let findOrderInformation = {

	}

	var filtreText = "<p style='text-align:right'><a href='https://mdw-05.fr/reseau-psa/upload-orders/'>Upload orders</a></p>";

 filtreText += "<h2>Filters</h2>";
 filtreText += "<p style='text-align:center'><label for='startDate'>Start date</label>"; 
filtreText += "<form id='filterOrderForm'>";
	filtreText += '<input style="margin-left:10px;" type="date" id="startDate" name="startDate" min="2022-01-01" max="2050-12-31"></p>';
	filtreText += "<table><tr><td><label for='family'>Family</label>";
	filtreText += '<select style="display:block" id="family" name="family" multiple></td>';
filtreText += "<td><label for='countryCode'>Country Code</label>";
filtreText += '<select style="display:block" id="countryCode" name="countryCode" multiple></td>';
filtreText += "<td><label for='countryName'>Country Name</label>";
filtreText += '<select style="display:block" id="countryName" name="countryName" multiple></td>';
filtreText += "<td><label for='codePochette'>Code Pochette</label>";
filtreText += '<select style="display:block" id="codePochette" name="codePochette" multiple></td>';
	filtreText += "<td><label for='partNumber'>Part Number</label>";
	filtreText += '<input style="display:block" type="text" id="partNumber" name="partNumber" placeHolder="23AMOKKDEXX32D3,23AMOKKDEXX32A5"></td>';
	filtreText += '</tr></table>';
	filtreText += '<div class="button__container">'
	filtreText += '<input style="width:120px; height: 50px; border-radius:5px; padding: 10px; margin: 10px;" type="submit" value="Refresh"/>'
	filtreText += '<input style="width:120px; height: 50px; background: white; border-radius:5px; color: red; border: 0.5px solid red; padding: 10px; margin: 10px;" type="button" onclick="filterOrder(event, true)" value="Clear Filter"/>'	
	filtreText += '</div>'
	filtreText += "</form>";


	/**
	 * Masque la modal update Order
	 */
	function hideUpdateOrder() {
		if(updateOrderElement) {
			updateOrderElement.hidden = true;
		}		
	}

	/**
	 * Affichage modal updateOrder element
	 */
	function displayUpdateOrderElement(element) {
		// Récupération HtmlElement
		orderElement = element;

		// Affichage modal
		if(updateOrderElement) {
			updateOrderElement.hidden = false;			
		}

		// Affichage spinner chargement
		if(spinnerLoaderElement) {
				spinnerLoaderElement.hidden = false;
		}

		// Récupération id de la commande
		const orderId = element.dataset.orderId;

		if(!orderId) {
			return alert('impossible de récupérer la commande');
		}

		// Recherche de la commande en base de données
		findOrder(orderId);
	}

	/**
	 * Soumission formulaire
	 * @params {string} orderId
	 */
	function findOrder(orderId){
		mode === 2;
		const _lien_scriptPHP = "https://mdw-05.fr/wp-content/themes/redparts/get_order_information.php";
		let _variables = 'orderid=' + encodeURIComponent(orderId);
		AppelScriptPHP(_lien_scriptPHP, _variables);
	}

	/**
	 * Soumission formulaire
	 * @params {event} event
	 */
	function updateOrder(event) {
		mode === 2;
		event.preventDefault();

		// Affichage spinner chargement
		if(spinnerLoaderElement) {
				spinnerLoaderElement.hidden = false;
		}

		const formData = urlEncoded(Object.fromEntries(new FormData(event.target)));		
		const _lien_scriptPHP = "https://mdw-05.fr/wp-content/themes/redparts/update_order_on_dashboard.php";
		AppelScriptPHP(_lien_scriptPHP, formData);
	}

	/**
	 * Filtre les commandes
	 * @params {event} event
	 * @params {bool} clearFilter
	 */
	function filterOrder(event, clearFilter = false) {
		mode === 2;		
		event.preventDefault();

		// Reset du filtre
		if(clearFilter) {
			const dateFin = document.getElementById('startDate').value;
			var _variables = 'type=' + encodeURIComponent(type) + '&dateFin=' + encodeURIComponent(dateFin);
			const _lien_scriptPHP = "https://mdw-05.fr/wp-content/themes/redparts/get_dashboard.php";
			AppelScriptPHP(_lien_scriptPHP, _variables);
		} else {		
			const formData = urlEncoded(Object.fromEntries(new FormData(event.target)));
			console.log(formData);
			const _lien_scriptPHP = "https://mdw-05.fr/wp-content/themes/redparts/filter_order_dashboard.php";
			AppelScriptPHP(_lien_scriptPHP, formData);
		}		
	}

	/**
	 * Mise a jour de la modal updateOrder avec les données de la base de données
	 * 
	 * @params {object} findOrder
	 */
	function updateOrderModalElement(findOrder) {
		const partNumberElement = document.getElementById('displayPartNumber');
		const quantityElement = document.getElementById('displayQuantity');
		const deliveredDateElement = document.getElementById('displayDeliveredDate');
		const statusElement = document.getElementById('displayStatus');
		const idElement = document.getElementById('id');

		if(partNumberElement && quantityElement && deliveredDateElement && statusElement) {
			idElement.value = findOrder[0].id;
			partNumberElement.innerText = findOrder[0].partNumber;
			quantityElement.value = findOrder[0].quantity;
			deliveredDateElement.value = findOrder[0].deliveredDate;
			statusElement.value = findOrder[0].wipId.toLowerCase();
		}

		console.log(findOrder);
	}

	/**
	 * Transforme les données en format urlEncoded
	 * @params {object} datas - Données a passer au format urlEnconded
	 */
	function urlEncoded(datas) {
		let formBody = [];
		for (let property in datas) {
			let encodedKey = encodeURIComponent(property);
			let encodedValue = encodeURIComponent(datas[property]);
			formBody.push(encodedKey + "=" + encodedValue);
		}

		return formBody.join("&");
	}

	/**
	 * Affichage flashMessage
	 * 
	 * @params {text} message - message a afficher
	 * @params {bool} error - Flash error
	 */
	function displayFlashMessage(message, error) {
		if(flashMessageElement) {


			// Affichage message
			flashMessageElement.classList.add('flash--fade');

			// Message a afficher
			document.getElementById('flashMessageText').innerText = message;

			// Masque le message
			setTimeout(()=>{
				flashMessageElement.classList.remove('flash--fade');
			}, 5000)
		}
	}

	/**
	 * Mise a jour de la couleur après un update de commande
	 * 
	 * @params {object} colorData - contient les données de couelur
	 */
	function updateOrderColor(colorData) {
		// Affichage Flash Message
		displayFlashMessage('Succes de la mise à jour de votre commande');

		if(!orderElement) {
			return;
		}

		// Récupération HTML enfant ayant la couleur
		const divOrderElement = orderElement.firstChild;

		// Suppression des class de couleur
		for(classColor of colorData.colorClassToRemove) {
			divOrderElement.classList.remove(classColor)
		}

		// Ajoutr de la nouvelle class
		divOrderElement.classList.add(colorData.colorClassName);

		// Masque spinner chargement
		if(spinnerLoaderElement) {
			spinnerLoaderElement.hidden = true;
		}

		// Masque la modal update Order
		if(updateOrderElement) {
			updateOrderElement.hidden = true;			
		}
	}

	function $_GET(param) {
		var vars = {};
		window.location.href.replace( location.hash, '' ).replace(
		/[?&]+([^=&]+)=?([^&]*)?/gi, // regexp
		function( m, key, value ) { // callback
			vars[key] = value !== undefined ? value : '';
			if(vars[key].substring(vars[key].length-1)=="#")
			vars[key] = vars[key].substring(0,vars[key].length-1);
		}
		);

		if ( param ) {
			return vars[param] ? vars[param] : null;
		}
		return vars;
	}


	function chargement() {
		document.getElementById("chargement-page").style.display = "block";
		document.getElementById("resultat-page").classList.add("invisible");
	}

	var mode = 1;
	var type;

	window.onload=function(){	

		/////////////////////////// EVENT /////////////////////////////////////////////
		document.getElementById("message").addEventListener('input', resetMessage);
		function resetMessage() {
			document.getElementById("resultat").innerHTML ="<p></p>";
		}

		document.getElementById("btn-go").addEventListener('click', rechercheGo);

function rechercheGo(e)
{
	e.preventDefault();
gestionAppel();
}

		window.addEventListener('click', function(e){
			if (document.getElementById('popup').contains(e.target) || document.getElementById('order_table').contains(e.target)){
				// Clicked in box


				// if (document.getElementById('documents').contains(e.target))
				// {
				// 	document.getElementById("table-lot").style.display = "none";
				// 	document.getElementById("lots").classList.remove("active");
				//
				// 	document.getElementById("table-document").style.display = "block";
				// 	document.getElementById("documents").classList.add("active");
				//
				// 	document.getElementById("table-tracking").style.display = "none";
				// 	document.getElementById("tracking").classList.remove("active");
				//
				// 	document.getElementById("table-commentaire").style.display = "none";
				// 	document.getElementById("commentaires").classList.remove("active");
				// }
				/////////////////////////// EVENT /////////////////////////////////////////////

			}
			else{
				//$('#popup').hide();
				document.getElementById('popup').style.display = "none";
			}
		});

		/////////////////////////////////// INIT //////////////////////////////////////////
		document.getElementById("filter-div").innerHTML = filtreText;

		// Select day on filter
		selectDayFilterElement = document.getElementById('startDate');

		if(selectDayFilterElement) {
			// date du jour
			selectDayFilterElement.valueAsDate = new Date()
		}

		type = "1";
		//id_lot= $_GET('id_lot');
		//id_projet= $_GET('id_projet');

		gestionAppel();


	}
	function elementPosition (a) {
	  var b = a.getBoundingClientRect();
	  return {
	    clientX: a.offsetLeft,
	    clientY: a.offsetTop,
	    viewportX: (b.x || b.left),
	    viewportY: (b.y || b.top)
	  }
	}
	function getDocumentSize()
{
	return new Array((document.documentElement && document.documentElement.scrollWidth) ? document.documentElement.scrollWidth : (document.body.scrollWidth > document.body.offsetWidth) ? document.body.scrollWidth : document.body.offsetWidth,(document.documentElement && document.documentElement.scrollHeight) ? document.documentElement.scrollHeight : (document.body.scrollHeight > document.body.offsetHeight) ? document.body.scrollHeight : document.body.offsetHeight);
}

	function affichePopup(ids,idnumRows)
	{
for(x=1;x<5000;x++)
{
		//reset style
	if(document.body.contains(document.getElementById("row-"+x)))
	{
		document.getElementById("row-"+x).style.backgroundColor = "#FFF";
		document.getElementById("row-"+x).style.color = "#262626";
	}
	else {
		break;
	}
}

		document.getElementById(idnumRows).style.backgroundColor = "#1e4faa";
		document.getElementById(idnumRows).style.color = "#FFF";
		var positions = elementPosition(document.getElementById(idnumRows));
		var hauteur = getDocumentSize();
		console.log({
			 "Hauteur vertical de la page": hauteur[1],
			 "Position verticale dans la fenêtre": positions.clientY,
			 "Position horizontale dans le document": positions.viewportX,
			 "Position verticale dans le document": positions.viewportY
		});
		const nposY=positions.clientY-hauteur[1]+1500;
		document.getElementById('popup').style.top=nposY+"px";
		document.getElementById('popup').style.height="400px";


		document.getElementById('popup').style.display = "block";
		document.getElementById('popup').innerHTML = "<h5 style='text-align:center;margin-top:100px;'>... Loading data in progress ...</h5>";

		const _lien_scriptPHP = "https://mdw-05.fr/wp-content/themes/redparts/get_popup_LongTerm.php";


		var _variables = 'ids=' + encodeURIComponent(ids);


		mode = 4; //STRING
		AppelScriptPHP(_lien_scriptPHP, _variables);

	}


	function initListes()
	{
		var categorie="appareil,site";
		const _lien_scriptPHP = "https://mdw-05.fr/wp-content/themes/redparts/get-listes.php";
		const _variables = 'categorie=' + encodeURIComponent(categorie);
		mode = 1; //JSON
		AppelScriptPHP(_lien_scriptPHP, _variables);
	}


	function gestionAppel()
	{

		//Chargement en cours
		chargement();
		const _lien_scriptPHP = "https://mdw-05.fr/wp-content/themes/redparts/get_dashboard.php";

		const dateFin = document.getElementById('startDate').value;
		// const appareil = document.getElementById('appareil');
		//
		// var sappareil = "";
		// for(x=0;x<appareil.length;x++)
		// {
		// 	if(appareil[x].selected == true)
		// 	sappareil += appareil[x].value + ", ";
		// }


	//	const contrat_technique = document.getElementById('contrat_technique').value;

		var _variables = 'type=' + encodeURIComponent(type) + '&dateFin=' + encodeURIComponent(dateFin);


		mode = 2; //JSON
		AppelScriptPHP(_lien_scriptPHP, _variables);
	}
	function AppelScriptPHP(lien_scriptPHP, variables)
	{
		httpRequest = new XMLHttpRequest();

		if (!httpRequest){
			alert('Il y a eu une erreur XMLHTTP. Merci de nous contacter.');
			return false;
		}



		//Afficher résultats par défaut
		httpRequest.onreadystatechange = alertContents;
		httpRequest.open('POST', lien_scriptPHP);
		httpRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

		httpRequest.send(variables);
	}

	function alertContents() {
		if (httpRequest.readyState === XMLHttpRequest.DONE) {
			if (httpRequest.status === 200) {

				var data; //string ou JSON
				if(mode == 1){
					try {
						data = JSON.parse(httpRequest.responseText);

						//document.getElementById("appareil").innerHTML = data['combo_liste_appareil'];

						//gestionAppel();
					}catch(e) {
						alert(e); // error in the above string (in this case, yes)!
					}
				}
				else if(mode == 2)
				{
					//try {
						data = JSON.parse(httpRequest.responseText);
						majResult(data);

						document.getElementById("chargement-page").style.display = "none";
						document.getElementById("resultat-page").classList.remove("invisible");


					// }catch(e) {
					// 	alert(e); // error in the above string (in this case, yes)!
					// }

				}
				if(mode>2){
					data = httpRequest.responseText;
					if(data.substring(0,5) == 'Error')
					{

						alert(data);
					}
					else{
						if(mode == 3){ //Si modification
							gestionAppel(type,id_lot); //rechargement des données de la page

							document.getElementById("resultat").innerHTML = "<p style='color:green;text-align:center'><strong>Mise à jour réussie !</strong></p>";
						}
						if(mode == 4){ //Si Popup
							document.getElementById('popup').style.display = "block";
							document.getElementById('popup').innerHTML = data;

						}
					}
				}
			}
			else {

				// Masque spinner chargement
				if(spinnerLoaderElement) {
						spinnerLoaderElement.hidden = true;
				}

				// Récupération du message d'erreur 
				data = httpRequest.responseText;

				if(!data) {
					return alert('Il y a eu une erreur. Merci de nous contacter.');
				}

				alert(data);
				
			}
		}
	}

	function downloadFile(link) {
		window.open(link,'_self');
		setTimeout(() => {
			document.getElementById("resultat-print").classList.add("invisible");
		}, "2000")
	}



	function majResult(data)
	{
		//MAJ Titre et WIP
		if(data['orders']) {
			document.getElementById('resultat-div').innerHTML = data['orders'];	
		}

		// Résulat d'une recherche de commande
		if(data['findOrder']) {

			// Mise a jour de l'affichage
			updateOrderModalElement(data['findOrder']);
		}

		// Resultat d'un update d'une commande
		if(data['updateOrder']) {
			const result = data['updateOrder'];	

			if(result) {
				updateOrderColor(result);
				
			}			
		}		

		// Loader de chargement
		spinnerLoaderElement = document.getElementById('loader');

		// Modal update commande
		updateOrderElement = document.getElementById('updateOrder');

		// Formulaire de soumission
		updateOrderFormElement = document.getElementById('updateOrderForm');

		// Formulaire de filtre
		filterOrderFormElement = document.getElementById('filterOrderForm');

		// Flash Message
		flashMessageElement = document.getElementById('flashMessage');

		if(updateOrderFormElement) {
			// Ajout soumission formulaire
			updateOrderFormElement.addEventListener('submit', updateOrder)
		}

		if(filterOrderFormElement) {
			// Ajout soumission formulaire de filtre
			filterOrderFormElement.addEventListener('submit', filterOrder);
		}

		// Masque la fenetre de chargement de la modal de modification
		if(spinnerLoaderElement) {
			spinnerLoaderElement.hidden = true;
		}	

		// for(x=0;x<2;x++)
		// {
		// 	var ctx = document.getElementById('myChart'+x);
		//   new Chart(ctx, {
		//     type: 'bar',
		//     data: {
		//       labels: [data['grapheTab'][x]['labels'][0],data['grapheTab'][x]['labels'][1],data['grapheTab'][x]['labels'][2],data['grapheTab'][x]['labels'][3]],
		//       datasets: [{
		//         label: data['grapheTab'][x]['label'],
		//         data: [data['grapheTab'][x]['data'][0], data['grapheTab'][x]['data'][1], data['grapheTab'][x]['data'][2], data['grapheTab'][x]['data'][3]],
		//         borderWidth: 1
		//       }]
		//     },
		//     options: {
		//       scales: {
		//         y: {
		//           beginAtZero: true
		//         }
		//       }
		//     }
		//   });
		//
		// }


	}




</script>